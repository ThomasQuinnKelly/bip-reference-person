# Open Policy Agent

## What is Open Policy Agent?
Open Policy Agent (OPA) is a policy engine that can be used to implement fine-grained access control for your application. For example, you can use OPA to implement authorization across microservices. However, there is much more that can be accomplished with OPA. There are several open-source projects that integrate with OPA to implement fine-grained access control like [Docker](https://github.com/open-policy-agent/opa-docker-authz), [Istio](https://github.com/open-policy-agent/opa-istio-plugin) and [others](https://github.com/open-policy-agent/contrib). Furthermore, OPA as a general-purpose policy engine, can be leveraged in use cases beyond access control, for instance to make advanced pod placement decisions in [Kubernetes](https://github.com/open-policy-agent/opa-kube-scheduler).

OPA can be deployed as a standalone service along with your microservices. In order to protect your application, each request coming to a microservice must be authorized before it can be processed. To check the authorization, the microservice makes an API call to OPA to decide whether the request is authorized or not. Note that while you can offload authorization decisions from your application to OPA, your application still has to implement the enforcement of those decisions. For example, the application can ask OPA the question “Is user with with stationID 310 allowed to invoke GET /api/v1/persons/pid” and if OPA answers “No”, your application has to send HTTP 403 Forbidden back to the user.

OPA is written in the Go language and its source code is available on GitHub under the Apache License 2.0. 

## Making policy decisions

What does it take for OPA to make a policy decision? In OPA, there are three inputs into the decision-making process:

1. **Data** is a set of facts about the outside world that OPA refers to while making a decision. For example, when controlling access based on the access control list, the data would be a list of users along with the permissions they were granted. Another example: when deciding where to place the next pod on the Kubernetes cluster, the data would be a list of Kubernetes nodes and their currently available capacity. Note that data may change over time and OPA caches its latest state in memory. The data must be provided to OPA in the JSON format.
2. **Query** Input triggers the decision computation. It specifies the question that OPA should decide upon. The query input must be formatted as JSON. For instance, for the question “Is user Alice allowed to invoke GET /protected/resource?” the query input would contain parameters: Alice, GET, and /protected/resource.
3. **Policy** specifies the computational logic that for the given data and query input yields a policy decision aka query result. The computational logic is described as a set of policy rules in the OPA’s custom policy language called Rego. Note that OPA doesn’t come with any pre-defined policies. OPA is a policy engine that is able to interpret a policy, however, in order to make use of it you have to create a policy yourself and provide it to OPA.

In order to make a policy decision, all three inputs (data, query input, and the policy) are fed into the Policy Engine. The Policy Engine interprets the rules included in the policy and based on the data and the query input makes a policy decision. The policy decision generated by the Policy Engine is a JSON document.

## Spring Security AccessDecisionVoter using OPA

[OPA Contrib Repository](https://github.com/open-policy-agent/contrib) holds integrations, examples, and proof-of-concepts that work with the Open Policy Agent (OPA) project. For HTTP API Authorization example, it demonstrates implementation of an [AccessDecisionVoter for Spring Security](https://docs.spring.io/spring-security/site/docs/4.2.4.RELEASE/reference/htmlsingle/#authz-voting-based) that uses OPA for making authorization decisions.

To enable the voter inside your application, you must configure it. Spring Security has sophisticated support for XML and Java-based configuration.

### BIP Framework Web Security Configuration

BIP security configuration will be updated to set the AccessDecisionManager that adds an org.springframework.security.access.AccessDecisionVoter implementation class named BipOpaVoter. This voter class in BIP framework will override a method to vote on authorization decisions, indicates whether or not access is granted. The decision must be affirmative {@code ACCESS_GRANTED}, negative {@code ACCESS_DENIED} or  abstain ({@code ACCESS_ABSTAIN}) from voting. 

BIP framework will provide properties to support OPA configurations. Recommended properties are listed below.

  **bip.framework.security.opa.enabled** Boolean flag to enable or disable OPA, default set to false
  **bip.framework.security.opa.urls** Multiple Open Policy Agent URLs to get the policy decision result, default empty array
  **bip.framework.security.opa.allVotersAbstainGrantAccess** Boolean that indicates if all or any voters are required to abstain or grant access, default value is false. Value as false sets AccessDecisionManager with UnanimousBased implementation and true with AffirmativeBased impl. 

### Running OPA

BIP provides in reference person example service `local-dev` docker compose file to run the OPA locally. If you are running your service in IDE (default app profile), then you can execute command by navigating to the directory `local-dev/openpolicyagent`. command to execute: `docker-compose -f docker-compose.yml up --build` 

If you are running in `local-int` profile, then run `./start-all.sh` from the root folder of BIP Reference Person Repository. 

For now, POC is available under the following repos:

https://github.ec.va.gov/EPMO/bip-framework/tree/opaPOC
https://github.ec.va.gov/EPMO/bip-reference-person/tree/opaPOC

Folders/Files to refer:
  - https://github.ec.va.gov/EPMO/bip-reference-person/tree/opaPOC/local-dev/openpolicyagent
  - https://github.ec.va.gov/EPMO/bip-reference-person/blob/opaPOC/bip-reference-person/src/main/resources/bip-reference-person.yml#L223
  - https://github.ec.va.gov/EPMO/bip-reference-person/blob/opaPOC/docker-compose.yml#L26
  - https://github.ec.va.gov/EPMO/bip-reference-person/blob/opaPOC/docker-compose.yml#L100

  
 
