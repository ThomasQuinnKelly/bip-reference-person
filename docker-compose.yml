version: "3.3"

services:
  
  # Fill this out once the dev team has their app code into the repo
  bip-reference-person:
    image: bipdev/bip-reference-person
    build:
      context: ./bip-reference-person
    environment:
      - spring.profiles.active=local-int
      - spring.profiles.include=remote_client_sims
      - spring.cloud.consul.host=consul
      - spring.redis.host=redis
      - spring.cloud.vault.host=vault
      - spring.cloud.consul.enabled=true
      - spring.cloud.consul.config.enabled=true
      - spring.cloud.consul.config.failFast=true
      - spring.cloud.consul.discovery.enabled=true
      - spring.cloud.consul.discovery.register=true
      - spring.cloud.vault.enabled=true
      - spring.cloud.vault.consul.enabled=true
      - bip.framework.security.jwt.enabled=true
      - spring.cloud.vault.kv.application-name=blue/bip-reference-person,blue/bip-reference-person/example-service
    ports:
      - "8080:8080"
    networks:
       - bip
    depends_on:
      - consul
      - redis
      - vault
      - vault-config
      - localstack

  localstack:
    image: localstack/localstack:0.10.7
    command: >
      sh -c "
        aws configure set region us-east-1 && 
        aws configure set aws_access_key_id test_key &&
        aws configure set aws_secret_access_key test_secret &&
        aws --endpoint-url=http://localhost:4575 sns create-topic --name test_my_topic &&
        aws --endpoint-url=http://localhost:4576 sqs create-queue --queue-name sub_new_queue && 
        aws --endpoint-url=http://localhost:4576 sqs create-queue --queue-name sub_new_queue_dead && 
        aws --endpoint-url=http://localhost:4575 sns subscribe --topic-arn arn:aws:sns:us-east-1:000000000000:test_my_topic --protocol sqs --notification-endpoint arn:aws:sns:us-east-1:000000000000:sub_new_queue
        "
    restart: on-failure
    ports:
      - "4567-4599:4567-4599"
      - "8888:8888"
    networks:
      - bip
    environment:
      - LOCALSTACK_SERVICES=sns,sqs
      - LOCALSTACK_PORT_WEB_UI=8888

  consul:
    image: bipdev/consul:1.4.3
    build:
      context: ./local-dev/consul
    environment:
      - MASTER_ACL_TOKEN=7652ba4c-0f6e-8e75-5724-5e083d72cfe4
    ports:
      - "8500:8500"
    networks:
      - bip

  vault:
    image: vault
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_TOKEN:-vaultroot}
    networks:
      - bip

  vault-config:
    image: bipdev/vault-config
    build:
      context: ./local-dev/vault-config
    environment:
      - VAULT_ADDR=http://vault:8200
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_TOKEN:-vaultroot}
      - CONSUL_HTTP_ADDR=http://consul:8500
      - CONSUL_HTTP_TOKEN=7652ba4c-0f6e-8e75-5724-5e083d72cfe4
    networks:
      - bip
    depends_on:
      - consul
      - vault

  redis:
    image: redis
    networks:
      - bip

  prometheus:
    image:  prom/prometheus:v2.5.0
    ports:
      - "9090:9090"
    volumes: 
      - "./local-dev/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml"
    networks:
      - bip
    depends_on:
      - consul

  grafana:
    image:  bipdev/grafana
    build:
      context: ./local-dev/grafana
    ports:
      - "3000:3000"
    networks:
      - bip
    depends_on:
      - prometheus

networks:
  bip:
    driver: bridge